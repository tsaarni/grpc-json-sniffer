/* @marcbachmann/cel-js | MIT License | https://github.com/marcbachmann/cel-js */
var d=class extends Error{#t=!1;constructor(t,n,r){super(t,{cause:r}),this.name="ParseError",n?.input&&(this.#t=!0,this.message=M(this.message,n))}withAst(t){return this.#t?this:t?.input?(this.message=M(this.message,t),this):this}},l=class extends Error{#t=!1;constructor(t,n,r){super(t,{cause:r}),this.name="EvaluationError",n?.input&&(this.#t=!0,this.message=M(this.message,n))}withAst(t){return this.#t?this:t?.input?(this.message=M(this.message,t),this):this}},m=class extends Error{#t=!1;constructor(t,n,r){super(t,{cause:r}),this.name="TypeError",n?.input&&(this.#t=!0,this.message=M(this.message,n))}withAst(t){return this.#t?this:t?.input?(this.message=M(this.message,t),this):this}};function M(e,t){if(t?.pos===void 0)return e;let n=t.pos,r=t.input,s=1,i=0,o=0;for(;i<n;)r[i]===`
`?(s++,o=0):o++,i++;let u=n,h=n;for(;u>0&&r[u-1]!==`
`;)u--;for(;h<r.length&&r[h]!==`
`;)h++;let f=r.slice(u,h),w=`${s}`.padStart(4," "),y=" ".repeat(9+o);return`${e}

> ${w} | ${f}
${y}^`}var T=class{#t;constructor(t){this.#t=t,Object.freeze(this)}get name(){return this.#t}get[Symbol.toStringTag](){return`Type<${this.#t}>`}toString(){return`Type<${this.#t}>`}},k={string:new T("string"),bool:new T("bool"),int:new T("int"),uint:new T("uint"),double:new T("double"),map:new T("map"),list:new T("list"),bytes:new T("bytes"),null_type:new T("null"),type:new T("type"),google:{protobuf:{Timestamp:new T("google.protobuf.Timestamp"),Duration:new T("google.protobuf.Duration")}}};k["google.protobuf.Timestamp"]=k.google.protobuf.Timestamp;k["google.protobuf.Duration"]=k.google.protobuf.Duration;var R=class{constructor({kind:t,type:n,stringValue:r,name:s,keyType:i,valueType:o,values:u}){t&&(this.kind=t),n&&(this.type=n),s&&(this.name=s),i&&(this.keyType=i),o&&(this.valueType=o),u&&(this.values=u),Object.freeze(this)}isDynOrBool(){return this.type==="bool"||this.type==="dyn"}toString(){return this.name}},F=class{constructor({name:t,receiverType:n,argTypes:r,returnType:s,handler:i,typeCheck:o=null}){if(this.name=t,this.macro=r.includes(q),n){let h=n.name||String(n);h==="list<dyn>"?this.receiverType="list":h==="map<dyn, dyn>"?this.receiverType="map":this.receiverType=h}else this.receiverType=null;this.argTypes=r,this.returnType=s;let u=n?`${n}.`:"";this.signature=`${u}${t}(${r.join(", ")}): ${s}`,this.handler=i,this.typeCheck=o,Object.freeze(this)}};function tt(e){return new R({kind:"list",name:`list<${e}>`,type:"list",valueType:e})}function $(e){return new R({kind:"primitive",name:e,type:e})}function Ft(e){return new R({kind:"message",name:e,type:e})}function et(e,t){return new R({kind:"map",name:`map<${e}, ${t}>`,type:"map",keyType:e,valueType:t})}var E=$("dyn"),q=$("ast"),G=class{#t=[];exists=!1;hasMacro=!1;add(t){this.exists=!0,t.macro&&(this.hasMacro=!0),this.#t.push(t)}get functions(){return this.#t}findMatch(t){if(!this.exists)return null;for(let n of this.#t)if(this.#e(n,t))return n;return null}#e(t,n){for(let r=0;r<n.length;r++){let s=t.argTypes[r],i=n[r];if(!(s.type==="dyn"||i==="dyn")&&s.type!==i)return!1}return!0}},zt=new G,nt=class{exists=!1;hasMacro=!1;returnType=null;#t=new Map;add(t){this.exists=!0,t.macro&&(this.hasMacro=!0),this.returnType?this.returnType!==t.returnType&&(this.returnType=E):this.returnType=t.returnType;let n=t.receiverType;(this.#t.get(n)||this.#t.set(n,new G).get(n)).add(t)}filterByReceiverType(t){return this.#t.get(t)||zt}},Z=Object.freeze({string:$("string"),bool:$("bool"),int:$("int"),uint:$("uint"),double:$("double"),bytes:$("bytes"),dyn:E,null:$("null"),type:$("type"),"google.protobuf.Timestamp":$("google.protobuf.Timestamp"),"google.protobuf.Duration":$("google.protobuf.Duration"),list:tt(E),"list<dyn>":tt(E),map:et(E,E),"map<dyn, dyn>":et(E,E)});function mt(e){let t=[],n="",r=0;for(let s of e){if(s==="<")r++;else if(s===">")r--;else if(s===","&&r===0){t.push(n),n="";continue}n+=s}return n&&t.push(n),t}var wt=new Set(Object.keys(k)).add("null").add("dyn");wt.delete("google");function P(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(n=>P(n));if(e instanceof Map)return new Map([...e].map(([n,r])=>[n,P(r)]));if(e instanceof Set)return new Set([...e].map(n=>P(n)));if(e.constructor&&e.constructor!==Object)return e;let t=Object.create(Object.getPrototypeOf(e));for(let n of Object.keys(e))t[n]=P(e[n]);return t}var rt=class e{#t;#e;#r;#i;#n;constructor({typeDeclarations:t,...n}={}){n=P(n||{}),this.#t=n.overloads??{},this.#e=n.objectTypes??new Map,this.#r=n.objectTypesByConstructor??new Map,this.#i=n.objectTypeInstances??new Map,this.#n={...t||Z}}get overloads(){return this.#t}getFunctionCandidates(t,n,r){let s=new nt;for(let i in this.#n){let o=this.#n[i];o instanceof F&&n===o.name&&(t===null&&o.receiverType||t&&o.receiverType===null||(s.exists=!0,o.macro&&(s.hasMacro=!0),o.argTypes.length===r&&s.add(o)))}return s}get typeDeclarations(){return this.#n}get objectTypes(){return this.#e}get objectTypesByConstructor(){return this.#r}get objectTypeInstances(){return this.#i}getType(t){return this.#o(t,!0)}getFunctionType(t){return t==="ast"?q:this.#o(t,!0)}registerType(t,n,r){let s={name:t,ctor:typeof n=="function"?n:n?.ctor,fields:this.#h(t,n?.fields)};if(!r){if(this.#e.has(t))throw new Error(`Type already registered: ${t}`);if(typeof s.ctor!="function")throw new Error(`Constructor function missing for type '${t}'`)}if(this.#e.set(t,s),this.#r.set(s.ctor,s),r)return;let i=new T(t);this.#i.set(t,i),this.registerFunctionOverload(`dyn(${t}): dyn`,o=>o),this.registerFunctionOverload(`type(${t}): type`,()=>i)}#s(t){let n=t.replace(/^dyn<(.+)>$/,"$1");return wt.has(n)||this.#e.has(n)}#o(t,n=!1){if(Z[t])return Z[t];if(this.#n[t])return this.#n[t];if(this.#e.has(t))return this.#a(t);let r=t.match(/^list<(.+)>$/);if(r){let i=this.#o(r[1].trim(),n);return this.#l(i)}let s=t.match(/^map<(.+)>$/);if(s){let i=mt(s[1]);if(i.length!==2)throw new Error(`Invalid map type: ${t}`);let o=this.#o(i[0].trim(),n),u=this.#o(i[1].trim(),n);return this.#c(o,u)}if(n)throw new Error(`Unknown type: ${t}`);return this.#a(t)}#a(t){return this.#n[t]??=Ft(t)}#l(t){let n=`list<${t}>`;return this.#n[n]??=tt(t)}#c(t,n){let r=`map<${t}, ${n}>`;return this.#n[r]??=et(t,n)}#u(t,n,r,s=!1){try{let i=typeof n[r]=="string"?{type:n[r]}:{...n[r]};if(typeof i?.type!="string")throw new Error("unsupported declaration");return this.#o(i.type,s)}catch(i){throw i.message=`Field '${r}' in type '${t}' has unsupported declaration: ${JSON.stringify(n[r])}`,i}}#h(t,n){if(!n)return;let r={};for(let s of Object.keys(n))r[s]=this.#u(t,n,s);return r}clone(){return new e({overloads:this.#t,objectTypes:this.#e,objectTypesByConstructor:this.#r,objectTypeInstances:this.#i,typeDeclarations:this.#n})}#p(t,n,r){let s=t.match(/^(?:([a-zA-Z0-9.]+)\.)?(\w+)\((.*?)\):\s*(.+)$/);if(!s)throw new Error(`Invalid signature: ${t}`);let[,i,o,u,h]=s;try{return new F({name:o,receiverType:i?this.getType(i.trim()):null,returnType:this.getType(h.trim()||"dyn"),argTypes:mt(u).map(f=>this.getFunctionType(f.trim())),handler:n,typeCheck:r})}catch{throw new Error(`Invalid function declaration: ${t}`)}}#f(t,n){return t.name!==n.name||t.argTypes.length!==n.argTypes.length||(t.receiverType||n.receiverType)&&(!t.receiverType||!n.receiverType)?!1:!(t.receiverType!==n.receiverType&&t.receiverType!==E&&n.receiverType!==E)&&(n.macro||t.macro||n.argTypes.every((s,i)=>{let o=t.argTypes[i];return s===o||s===q||o===q||s===E||o===E}))}#g(t){for(let n in this.#n){let r=this.#n[n];if(r instanceof F&&this.#f(r,t))throw new Error(`Function signature '${t.signature}' overlaps with existing overload '${r.signature}'.`)}}registerFunctionOverload(t,n){let r=typeof n=="function"?n:n.handler,s=typeof n=="function"?{}:n,i=this.#p(t,r,s.typeCheck);this.#g(i),this.#n[i.signature]=i}registerOperatorOverload(t,n){let r=t.match(/^([-!])([\w.<>]+)(?::\s*([\w.<>]+))?$/);if(r){let[,f,w,y]=r;return this.unaryOverload(f,w,n,y)}let s=t.match(/^([\w.<>]+) ([-+*%/]|==|!=|<|<=|>|>=|in) ([\w.<>]+)(?::\s*([\w.<>]+))?$/);if(!s)throw new Error(`Operator overload invalid: ${t}`);let[,i,o,u,h]=s;return this.binaryOverload(i,o,u,n,h)}unaryOverload(t,n,r,s){if(!this.#s(n))throw new Error(`Invalid type '${n}' in '${t}${n}'`);try{s=this.getType(s||n)}catch{throw new Error(`Invalid return type '${s}' in '${t}${n}: ${s}'`)}let i=`${t}_`;if(this.#t[i]??={},!this.#t[i][n])this.#t[i][n]={handler:r,returnType:s};else throw new Error(`Operator overload already registered: ${t}${n}`)}binaryOverload(t,n,r,s,i){if(!this.#s(t))throw new Error(`Invalid left type '${t}' in '${t} ${n} ${r}'`);if(!this.#s(r))throw new Error(`Invalid right type '${r}' in '${t} ${n} ${r}'`);try{i=i?this.getType(i):void 0}catch{throw new Error(`Invalid return type '${i}' in '${t} ${n} ${r}: ${i}'`)}if(n==="<"||n==="<="||n===">"||n===">="||n==="=="||n==="!="||n==="in"){if(i??=this.getType("bool"),i.type!=="bool")throw new Error(`Comparison operator '${n}' must return 'bool', got '${i.type}'`)}else i??=this.getType(t);if(this.#t[n]??={},n==="=="){this.#t["!="]??={};let o=this.#t[n][t]??={},u=this.#t[n][r]??={},h=this.#t["!="][t]??={},f=this.#t["!="][r]??={};if(o[r])throw new Error(`Operator overload already registered: ${t} == ${r}`);if(u[t])throw new Error(`Operator overload already registered: ${r} == ${t}`);if(h[r])throw new Error(`Operator overload already registered: ${t} != ${r}`);if(f[t])throw new Error(`Operator overload already registered: ${r} != ${t}`);o[r]={handler:s,returnType:i},u[t]={handler:(w,y,A,B)=>s(y,w,A,B),returnType:i},h[r]={handler:(w,y,A,B)=>!s(w,y,A,B),returnType:i},f[t]={handler:(w,y,A,B)=>!s(y,w,A,B),returnType:i}}else{let o=this.#t[n][t]??={};if(o[r]===void 0)o[r]={handler:s,returnType:i};else throw new Error(`Operator overload already registered: ${t} ${n} ${r}`)}}};function Vt(e){return new rt(e)}var S=Vt();var a={EOF:0,NUMBER:1,STRING:2,BOOLEAN:3,NULL:4,IDENTIFIER:5,PLUS:6,MINUS:7,MULTIPLY:8,DIVIDE:9,MODULO:10,EQ:11,NE:12,LT:13,LE:14,GT:15,GE:16,AND:17,OR:18,NOT:19,IN:20,LPAREN:21,RPAREN:22,LBRACKET:23,RBRACKET:24,LBRACE:25,RBRACE:26,DOT:27,COMMA:28,COLON:29,QUESTION:30,BYTES:31},g=class extends Array{#t;#e;constructor(t,n,r){super(),this.#t=t,this.#e=n,this.push(...r)}get input(){return this.#e}get pos(){return this.#t}},H={};for(let e in a)H[a[e]]=e;var Yt=new Set(["as","break","const","continue","else","for","function","if","import","let","loop","package","namespace","return","var","void","while"]),Tt=new Uint8Array(256);for(let e of"0123456789abcdefABCDEF")Tt[e.charCodeAt(0)]=1;var st=new Uint8Array(256);for(let e of"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_")st[e.charCodeAt(0)]=1;var bt={"\\":"\\","?":"?",'"':'"',"'":"'","`":"`",a:"\x07",b:"\b",f:"\f",n:`
`,r:"\r",t:"	",v:"\v"},it=class{constructor(t){this.input=t,this.pos=0,this.length=t.length}nextToken(){if(this.pos>=this.length)return{type:a.EOF,value:null,pos:this.pos};let t=this.input[this.pos],n=this.input[this.pos+1];switch(t){case" ":case"	":case`
`:case"\r":return this.pos++,this.nextToken();case"=":if(n!=="=")break;return{type:a.EQ,value:"==",pos:(this.pos+=2)-2};case"&":if(n!=="&")break;return{type:a.AND,value:"&&",pos:(this.pos+=2)-2};case"|":if(n!=="|")break;return{type:a.OR,value:"||",pos:(this.pos+=2)-2};case"+":return{type:a.PLUS,value:"+",pos:this.pos++};case"-":return{type:a.MINUS,value:"-",pos:this.pos++};case"*":return{type:a.MULTIPLY,value:"*",pos:this.pos++};case"/":if(n==="/"){for(;this.pos<this.length&&this.input[this.pos]!==`
`;)this.pos++;return this.nextToken()}return{type:a.DIVIDE,value:"/",pos:this.pos++};case"%":return{type:a.MODULO,value:"%",pos:this.pos++};case"<":return n==="="?{type:a.LE,value:"<=",pos:(this.pos+=2)-2}:{type:a.LT,value:"<",pos:this.pos++};case">":return n==="="?{type:a.GE,value:">=",pos:(this.pos+=2)-2}:{type:a.GT,value:">",pos:this.pos++};case"!":return n==="="?{type:a.NE,value:"!=",pos:(this.pos+=2)-2}:{type:a.NOT,value:"!",pos:this.pos++};case"(":return{type:a.LPAREN,value:"(",pos:this.pos++};case")":return{type:a.RPAREN,value:")",pos:this.pos++};case"[":return{type:a.LBRACKET,value:"[",pos:this.pos++};case"]":return{type:a.RBRACKET,value:"]",pos:this.pos++};case"{":return{type:a.LBRACE,value:"{",pos:this.pos++};case"}":return{type:a.RBRACE,value:"}",pos:this.pos++};case".":return{type:a.DOT,value:".",pos:this.pos++};case",":return{type:a.COMMA,value:",",pos:this.pos++};case":":return{type:a.COLON,value:":",pos:this.pos++};case"?":return{type:a.QUESTION,value:"?",pos:this.pos++};case'"':case"'":return this.readString();case"b":case"B":case"r":case"R":return n==='"'||n==="'"?(this.pos++,this.readString(t.toLowerCase())):this.readIdentifier();default:{if(t>="0"&&t<="9")return this.readNumber();if(st[t.charCodeAt(0)])return this.readIdentifier()}}throw new d(`Unexpected character: ${t}`,{pos:this.pos,input:this.input})}_parseAsBigInt(t,n,r,s){let i=this.input.substring(t,n);if(s==="u"||s==="U"){this.pos++;try{return{type:a.NUMBER,value:new x(i),pos:t}}catch{}}else try{return{type:a.NUMBER,value:BigInt(i),pos:t}}catch{}throw new d(r?`Invalid hex integer: ${i}`:`Invalid integer: ${i}`,{pos:t,input:this.input})}readNumber(){let{input:t,length:n,pos:r}=this;if(t[r]==="0"&&(t[r+1]==="x"||t[r+1]==="X")){for(this.pos+=2;this.pos<n&&Tt[t[this.pos].charCodeAt(0)];)this.pos++;return this._parseAsBigInt(r,this.pos,!0,t[this.pos])}let s;for(;this.pos<n&&(s=t[this.pos])>="0"&&s<="9";)this.pos++;if(s==="."&&(s=t[this.pos+1])>="0"&&s<="9"){for(this.pos++;this.pos<n&&(s=t[this.pos])>="0"&&s<="9";)this.pos++;let i=t.substring(r,this.pos),o=Number(i);if(Number.isFinite(o))return{type:a.NUMBER,value:o,pos:r};throw new d(`Invalid number: ${o}`,{pos:r,input:this.input})}return this._parseAsBigInt(r,this.pos,!1,t[this.pos])}readString(t){let n=this.input[this.pos++];return this.input[this.pos]===n&&this.input[this.pos+1]===n?(this.pos+=2,this.readTripleQuotedString(n,t)):this.readSingleQuotedString(n,t)}_closeQuotedString(t,n){if(n==="b"){let s=this.processEscapes(t,!0),i=new Uint8Array(s.length);for(let o=0;o<s.length;o++)i[o]=s.charCodeAt(o)&255;return{type:a.BYTES,value:i,pos:this.pos-t.length-2}}let r=n==="r"?t:this.processEscapes(t,!1);return{type:a.STRING,value:r,pos:this.pos-t.length}}readSingleQuotedString(t,n){let{input:r,length:s,pos:i}=this,o=n!=="r";for(;this.pos<s;){let u=r[this.pos];if(u===t){let h=r.slice(i,this.pos);return this.pos++,this._closeQuotedString(h,n)}if(u===`
`||u==="\r")throw new d("Newlines not allowed in single-quoted strings",{pos:i-1,input:r});if(u==="\\"&&o){if(this.pos+=2,this.pos>s)throw new d("Unterminated escape sequence",{pos:i-1,input:r});continue}this.pos++}throw new d("Unterminated string",{pos:i-1,input:r})}readTripleQuotedString(t,n){let r=this.pos,s=n!=="r";for(;this.pos<this.length;){let i=this.input[this.pos];if(i===t&&this.input[this.pos+1]===t&&this.input[this.pos+2]===t){let o=this.input.slice(r,this.pos);return this.pos+=3,this._closeQuotedString(o,n)}if(i==="\\"&&s){if(this.pos+=2,this.pos>this.length)throw new d("Unterminated escape sequence",{pos:r-3,input:this.input});continue}this.pos++}throw new d("Unterminated triple-quoted string",{pos:r-3,input:this.input})}processEscapes(t,n){let r="",s=0;for(;s<t.length;){if(t[s]!=="\\"||s+1>=t.length){r+=t[s++];continue}let i=t[s+1];if(bt[i])r+=bt[i],s+=2;else if(i==="u"){if(n)throw new d("\\u not allowed in bytes literals");let o=t.substring(s+2,s+6);if(o.length!==4||!/^[0-9a-fA-F]{4}$/.test(o))throw new d(`Invalid Unicode escape: \\u${o}`);let u=Number.parseInt(o,16);if(u>=55296&&u<=57343)throw new d(`Invalid Unicode surrogate: \\u${o}`);r+=String.fromCharCode(u),s+=6}else if(i==="U"){if(n)throw new d("\\U not allowed in bytes literals");let o=t.substring(s+2,s+10);if(o.length!==8||!/^[0-9a-fA-F]{8}$/.test(o))throw new d(`Invalid Unicode escape: \\U${o}`);let u=Number.parseInt(o,16);if(u>1114111)throw new d(`Invalid Unicode escape: \\U${o}`);if(u>=55296&&u<=57343)throw new d(`Invalid Unicode surrogate: \\U${o}`);r+=String.fromCodePoint(u),s+=10}else if(i==="x"||i==="X"){let o=t.substring(s+2,s+4);if(o.length!==2||!/^[0-9a-fA-F]{2}$/.test(o))throw new d(`Invalid hex escape: \\${i}${o}`);r+=String.fromCharCode(Number.parseInt(o,16)),s+=4}else if(i>="0"&&i<="7"){let o=t.substring(s+1,s+4);if(o.length!==3||!/^[0-7]{3}$/.test(o))throw new d("Octal escape must be 3 digits");let u=Number.parseInt(o,8);if(u>255)throw new d(`Octal escape out of range: \\${o}`);r+=String.fromCharCode(u),s+=4}else throw new d(`Invalid escape sequence: \\${i}`)}return r}readIdentifier(){let t=this.pos;for(;this.pos<this.length&&st[this.input[this.pos].charCodeAt(0)];)this.pos++;let n=this.input.substring(t,this.pos);switch(n){case"true":return{type:a.BOOLEAN,value:!0,pos:t};case"false":return{type:a.BOOLEAN,value:!1,pos:t};case"null":return{type:a.NULL,value:null,pos:t};case"in":return{type:a.IN,value:"in",pos:t};default:return{type:a.IDENTIFIER,value:n,pos:t}}}},D=class{constructor(t){this.input=t,this.lexer=new it(t),this.currentToken=this.lexer.nextToken()}consume(t){let n=this.currentToken;if(this.currentToken=this.lexer.nextToken(),n.type===t)return n;throw new d(`Expected ${H[t]}, got ${H[n.type]}`,{pos:n.pos,input:this.input})}match(t){return this.currentToken.type===t}parse(){let t=this.parseExpression();if(!this.match(a.EOF))throw new d(`Unexpected character: '${this.input[this.lexer.pos-1]}'`,{pos:this.currentToken.pos,input:this.input});return t}parseExpression(){let t=this.parseLogicalOr();if(this.match(a.QUESTION)){let n=this.consume(a.QUESTION),r=this.parseExpression();return this.consume(a.COLON),new g(n.pos,this.input,["?:",t,r,this.parseExpression()])}return t}parseLogicalOr(){let t=this.parseLogicalAnd();for(;this.match(a.OR);){let n=this.consume(a.OR);t=new g(n.pos,this.input,[n.value,t,this.parseLogicalAnd()])}return t}parseLogicalAnd(){let t=this.parseEquality();for(;this.match(a.AND);){let n=this.consume(a.AND);t=new g(n.pos,this.input,[n.value,t,this.parseEquality()])}return t}parseEquality(){let t=this.parseRelational();for(;this.match(a.EQ)||this.match(a.NE);){let n=this.currentToken;this.currentToken=this.lexer.nextToken(),t=new g(n.pos,this.input,[n.value,t,this.parseRelational()])}return t}parseRelational(){let t=this.parseAdditive();for(;this.match(a.LT)||this.match(a.LE)||this.match(a.GT)||this.match(a.GE)||this.match(a.IN);){let n=this.currentToken;this.currentToken=this.lexer.nextToken(),t=new g(n.pos,this.input,[n.value,t,this.parseAdditive()])}return t}parseAdditive(){let t=this.parseMultiplicative();for(;this.match(a.PLUS)||this.match(a.MINUS);){let n=this.currentToken;this.currentToken=this.lexer.nextToken(),t=new g(n.pos,this.input,[n.value,t,this.parseMultiplicative()])}return t}parseMultiplicative(){let t=this.parseUnary();for(;this.match(a.MULTIPLY)||this.match(a.DIVIDE)||this.match(a.MODULO);){let n=this.currentToken;this.currentToken=this.lexer.nextToken(),t=new g(n.pos,this.input,[n.value,t,this.parseUnary()])}return t}parseUnary(){let t=this.currentToken;return t.type===a.NOT?(this.currentToken=this.lexer.nextToken(),new g(t.pos,this.input,["!_",this.parseUnary()])):t.type===a.MINUS?(this.currentToken=this.lexer.nextToken(),new g(t.pos,this.input,["-_",this.parseUnary()])):this.parsePostfix()}assertReservedIdentifier(t){if(Yt.has(t.value))throw new d(`Reserved identifier: ${t.value}`,{pos:t.pos,input:this.input})}parsePostfix(){let t=this.parsePrimary();for(;;)if(this.match(a.DOT)){this.consume(a.DOT);let n=this.consume(a.IDENTIFIER);if(this.match(a.LPAREN)){this.consume(a.LPAREN);let r=this.parseArgumentList();this.consume(a.RPAREN),t=new g(n.pos,this.input,["rcall",n.value,t,r])}else t=new g(n.pos,this.input,[".",t,n.value])}else if(this.match(a.LBRACKET)){let n=this.consume(a.LBRACKET),r=this.parseExpression();this.consume(a.RBRACKET),t=new g(n.pos,this.input,["[]",t,r])}else break;return t}parsePrimary(){switch(this.currentToken.type){case a.NUMBER:{let t=this.consume(a.NUMBER);return new g(t.pos,this.input,["value",t.value])}case a.STRING:{let t=this.consume(a.STRING);return new g(t.pos,this.input,["value",t.value])}case a.BYTES:{let t=this.consume(a.BYTES);return new g(t.pos,this.input,["value",t.value])}case a.BOOLEAN:{let t=this.consume(a.BOOLEAN);return new g(t.pos,this.input,["value",t.value])}case a.NULL:{let t=this.consume(a.NULL);return new g(t.pos,this.input,["value",t.value])}case a.IDENTIFIER:{let t=this.consume(a.IDENTIFIER);if(this.assertReservedIdentifier(t),this.match(a.LPAREN)){this.consume(a.LPAREN);let n=this.parseArgumentList();return this.consume(a.RPAREN),new g(t.pos,this.input,["call",t.value,n])}return new g(t.pos,this.input,["id",t.value])}case a.LPAREN:{this.consume(a.LPAREN);let t=this.parseExpression();return this.consume(a.RPAREN),t}case a.LBRACKET:return this.parseList();case a.LBRACE:return this.parseMap()}throw new d(`Unexpected token: ${H[this.currentToken.type]}`,{pos:this.currentToken.pos,input:this.input})}parseList(){let t=this.consume(a.LBRACKET),n=[];if(!this.match(a.RBRACKET))for(n.push(this.parseExpression());this.match(a.COMMA);)this.consume(a.COMMA),this.match(a.RBRACKET)||n.push(this.parseExpression());return this.consume(a.RBRACKET),new g(t.pos,this.input,["list",n])}parseMap(){let t=this.consume(a.LBRACE),n=[];if(!this.match(a.RBRACE))for(n.push(this.parseProperty());this.match(a.COMMA);)this.consume(a.COMMA),this.match(a.RBRACE)||n.push(this.parseProperty());return this.consume(a.RBRACE),new g(t.pos,this.input,["map",n])}parseProperty(){let t=this.parseExpression();this.consume(a.COLON);let n=this.parseExpression();return[t,n]}parseArgumentList(){let t=[];if(!this.match(a.RPAREN))for(t.push(this.parseExpression());this.match(a.COMMA);)this.consume(a.COMMA),this.match(a.RPAREN)||t.push(this.parseExpression());return t}};var c=(e,t)=>S.registerFunctionOverload(e,t);c("has(ast): bool",function(e){let t=e[2][0];if(t[0]===".")return vt(this,t,e)!==void 0;throw new l("has() invalid argument",e)});function vt(e,t,n){if(t instanceof g)switch(t[0]){case"id":{let r=e.ctx.get(t[1]);if(r===void 0)throw new l(`Unknown variable: ${t[1]}`,t);return r}case".":{let r=vt(e,t[1],n);if(!r)throw new l(`No such key: ${t[2]}`,t);return Q(r,t[2],e.objectTypesByConstructor)}}throw new l("has() invalid argument",n)}for(let e in k){let t=k[e];t instanceof T&&(c(`dyn(${t.name}): dyn`,n=>n),c(`type(${t.name}): type`,()=>t))}c("bool(bool): bool",e=>e);c("bool(string): bool",e=>{switch(e){case"1":case"t":case"true":case"TRUE":case"True":return!0;case"0":case"f":case"false":case"FALSE":case"False":return!1;default:throw new l(`bool() conversion error: invalid string value "${e}"`)}});var $t=Object.keys;c("size(string): int",e=>BigInt(Bt(e)));c("size(bytes): int",e=>BigInt(e.length));c("size(list): int",e=>BigInt(e.length??e.size));c("size(map): int",e=>BigInt(e instanceof Map?e.size:$t(e).length));c("string.size(): int",e=>BigInt(Bt(e)));c("bytes.size(): int",e=>BigInt(e.length));c("list.size(): int",e=>BigInt(e.length??e.size));c("map.size(): int",e=>BigInt(e instanceof Map?e.size:$t(e).length));c("bytes(string): bytes",e=>L.fromString(e));c("bytes(bytes): bytes",e=>e);c("double(double): double",e=>e);c("double(int): double",e=>Number(e));c("double(string): double",e=>{if(!e||e!==e.trim())throw new l("double() type error: cannot convert to double");switch(e.toLowerCase()){case"inf":case"+inf":case"infinity":case"+infinity":return Number.POSITIVE_INFINITY;case"-inf":case"-infinity":return Number.NEGATIVE_INFINITY;case"nan":return Number.NaN;default:{let n=Number(e);if(!Number.isNaN(n))return n;throw new l("double() type error: cannot convert to double")}}});c("int(int): int",e=>e);c("int(double): int",e=>{if(Number.isFinite(e))return BigInt(Math.trunc(e));throw new l("int() type error: integer overflow")});c("int(string): int",e=>{if(e!==e.trim()||e.length>20||e.includes("0x"))throw new l("int() type error: cannot convert to int");try{let t=BigInt(e);if(t<=9223372036854775807n&&t>=-9223372036854775808n)return t}catch{}throw new l("int() type error: cannot convert to int")});c("uint(uint): uint",e=>e);c("uint(double): uint",e=>{if(Number.isFinite(e))return BigInt(Math.trunc(e));throw new l("int() type error: integer overflow")});c("uint(string): uint",e=>{if(e!==e.trim()||e.length>20||e.includes("0x"))throw new l("uint() type error: cannot convert to uint");try{let t=BigInt(e);if(t<=18446744073709551615n&&t>=0n)return t}catch{}throw new l("uint() type error: cannot convert to uint")});c("string(string): string",e=>e);c("string(bool): string",e=>`${e}`);c("string(int): string",e=>`${e}`);c("string(bytes): string",e=>L.toUtf8(e));c("string(double): string",e=>e===1/0?"+Inf":e===-1/0?"-Inf":`${e}`);c("string.startsWith(string): bool",(e,t)=>e.startsWith(t));c("string.endsWith(string): bool",(e,t)=>e.endsWith(t));c("string.contains(string): bool",(e,t)=>e.includes(t));c("string.indexOf(string): bool",(e,t)=>BigInt(e.indexOf(t)));c("string.indexOf(string, int): bool",(e,t,n)=>{if(t==="")return n;if(n=Number(n),n<0||n>=e.length)throw new l("string.indexOf(search, fromIndex): fromIndex out of range");return BigInt(e.indexOf(t,n))});c("string.lastIndexOf(string): bool",(e,t)=>BigInt(e.lastIndexOf(t)));c("string.lastIndexOf(string, int): bool",(e,t,n)=>{if(t==="")return n;if(n=Number(n),n<0||n>=e.length)throw new l("string.lastIndexOf(search, fromIndex): fromIndex out of range");return BigInt(e.lastIndexOf(t,n))});c("string.substring(int): string",(e,t)=>{if(t=Number(t),t<0||t>e.length)throw new l("string.substring(start, end): start index out of range");return e.substring(t)});c("string.substring(int, int): string",(e,t,n)=>{if(t=Number(t),t<0||t>e.length)throw new l("string.substring(start, end): start index out of range");if(n=Number(n),n<t||n>e.length)throw new l("string.substring(start, end): end index out of range");return e.substring(t,n)});c("string.matches(string): bool",(e,t)=>{try{return new RegExp(t).test(e)}catch{throw new l(`Invalid regular expression: ${t}`)}});c("string.split(string): list",(e,t)=>e.split(t));c("string.split(string, int): list",(e,t,n)=>e.split(t,n));c("list.join(): string",e=>{for(let t=0;t<e.length;t++)if(typeof e[t]!="string")throw new l("string.join(): list must contain only strings");return e.join("")});c("list.join(string): string",(e,t)=>{for(let n=0;n<e.length;n++)if(typeof e[n]!="string")throw new l("string.join(separator): list must contain only strings");return e.join(t)});var ot=new TextEncoder("utf8"),qt=new TextDecoder("utf8"),L=typeof Buffer<"u"?{byteLength:e=>Buffer.byteLength(e),fromString:e=>Buffer.from(e,"utf8"),toHex:e=>Buffer.prototype.hexSlice.call(e,0,e.length),toBase64:e=>Buffer.prototype.base64Slice.call(e,0,e.length),toUtf8:e=>Buffer.prototype.utf8Slice.call(e,0,e.length),jsonParse:e=>JSON.parse(e)}:{textEncoder:new TextEncoder("utf8"),byteLength:e=>ot.encode(e).length,fromString:e=>ot.encode(e),toHex:Uint8Array.prototype.toHex?e=>e.toHex():e=>Array.from(e,t=>t.toString(16).padStart(2,"0")).join(""),toBase64:Uint8Array.prototype.toBase64?e=>e.toBase64():e=>btoa(Array.from(e,t=>String.fromCodePoint(t)).join("")),toUtf8:e=>qt.decode(e),jsonParse:e=>JSON.parse(ot.decode(e))};c("bytes.json(): map",L.jsonParse);c("bytes.hex(): string",L.toHex);c("bytes.string(): string",L.toUtf8);c("bytes.base64(): string",L.toBase64);c("bytes.at(int): int",(e,t)=>{if(t<0||t>=e.length)throw new l("Bytes index out of range");return BigInt(e[t])});var b="google.protobuf.Timestamp";function I(e,t){return new Date(e.toLocaleString("en-US",{timeZone:t}))}function Et(e,t){let n=t?I(e,t):new Date(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate()),r=new Date(n.getFullYear(),0,0);return BigInt(Math.floor((n-r)/864e5)-1)}c(`timestamp(string): ${b}`,e=>{if(e.length<20||e.length>30)throw new l("timestamp() requires a string in ISO 8601 format");let t=new Date(e);if(t<=0xe677d21fdbff&&t>=-621355968e5)return t;throw new l("timestamp() requires a string in ISO 8601 format")});c(`timestamp(int): ${b}`,e=>{if(e=Number(e)*1e3,e<=0xe677d21fdbff&&e>=-621355968e5)return new Date(e);throw new l("timestamp() requires a valid integer unix timestamp")});c(`${b}.getDate(): int`,e=>BigInt(e.getUTCDate()));c(`${b}.getDate(string): int`,(e,t)=>BigInt(I(e,t).getDate()));c(`${b}.getDayOfMonth(): int`,e=>BigInt(e.getUTCDate()-1));c(`${b}.getDayOfMonth(string): int`,(e,t)=>BigInt(I(e,t).getDate()-1));c(`${b}.getDayOfWeek(): int`,e=>BigInt(e.getUTCDay()));c(`${b}.getDayOfWeek(string): int`,(e,t)=>BigInt(I(e,t).getDay()));c(`${b}.getDayOfYear(): int`,Et);c(`${b}.getDayOfYear(string): int`,Et);c(`${b}.getFullYear(): int`,e=>BigInt(e.getUTCFullYear()));c(`${b}.getFullYear(string): int`,(e,t)=>BigInt(I(e,t).getFullYear()));c(`${b}.getHours(): int`,e=>BigInt(e.getUTCHours()));c(`${b}.getHours(string): int`,(e,t)=>BigInt(I(e,t).getHours()));c(`${b}.getMilliseconds(): int`,e=>BigInt(e.getUTCMilliseconds()));c(`${b}.getMilliseconds(string): int`,e=>BigInt(e.getUTCMilliseconds()));c(`${b}.getMinutes(): int`,e=>BigInt(e.getUTCMinutes()));c(`${b}.getMinutes(string): int`,(e,t)=>BigInt(I(e,t).getMinutes()));c(`${b}.getMonth(): int`,e=>BigInt(e.getUTCMonth()));c(`${b}.getMonth(string): int`,(e,t)=>BigInt(I(e,t).getMonth()));c(`${b}.getSeconds(): int`,e=>BigInt(e.getUTCSeconds()));c(`${b}.getSeconds(string): int`,(e,t)=>BigInt(I(e,t).getSeconds()));var x=class{#t;constructor(t){this.verify(BigInt(t))}get value(){return this.#t}valueOf(){return this.#t}verify(t){if(t<0n||t>18446744073709551615n)throw new l("Unsigned integer overflow");this.#t=t}get[Symbol.toStringTag](){return`value = ${this.#t}`}[Symbol.for("nodejs.util.inspect.custom")](){return`UnsignedInteger { value: ${this.#t} }`}},Gt={h:3600000000000n,m:60000000000n,s:1000000000n,ms:1000000n,us:1000n,\u00B5s:1000n,ns:1n},U=class e{#t;#e;constructor(t,n=0){this.#t=BigInt(t),this.#e=n}get seconds(){return this.#t}get nanos(){return this.#e}valueOf(){return Number(this.#t)*1e3+this.#e/1e6}addDuration(t){let n=this.#e+t.nanos;return new e(this.#t+t.seconds+BigInt(Math.floor(n/1e9)),n%1e9)}subtractDuration(t){let n=this.#e-t.nanos;return new e(this.#t-t.seconds+BigInt(Math.floor(n/1e9)),(n+1e9)%1e9)}extendTimestamp(t){return new Date(t.getTime()+Number(this.#t)*1e3+Math.floor(this.#e/1e6))}subtractTimestamp(t){return new Date(t.getTime()-Number(this.#t)*1e3-Math.floor(this.#e/1e6))}toString(){let t=this.#e?(this.#e/1e9).toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:9}).slice(1):"";return`${this.#t}${t}s`}getHours(){return this.#t/3600n}getMinutes(){return this.#t/60n}getSeconds(){return this.#t}getMilliseconds(){return this.#t*1000n+BigInt(Math.floor(this.#e/1e6))}get[Symbol.toStringTag](){return"google.protobuf.Duration"}[Symbol.for("nodejs.util.inspect.custom")](){return`google.protobuf.Duration { seconds: ${this.#t}, nanos: ${this.#e} }`}},Ht=/(\d*\.?\d*)(ns|us|µs|ms|s|m|h)/;function Kt(e){if(!e)throw new l("Invalid duration string: ''");let t=e[0]==="-";(e[0]==="-"||e[0]==="+")&&(e=e.slice(1));let n=BigInt(0);for(;;){let i=Ht.exec(e);if(!i)throw new l(`Invalid duration string: ${e}`);if(i.index!==0)throw new l(`Invalid duration string: ${e}`);e=e.slice(i[0].length);let o=Gt[i[2]],[u="0",h=""]=i[1].split("."),f=BigInt(u)*o,w=h?BigInt(h.slice(0,13).padEnd(13,"0"))*o/10000000000000n:0n;if(n+=f+w,e==="")break}let r=n>=1000000000n?n/1000000000n:0n,s=Number(n%1000000000n);return t?new U(-r,-s):new U(r,s)}c("duration(string): google.protobuf.Duration",e=>Kt(e));c("google.protobuf.Duration.getHours(): int",e=>e.getHours());c("google.protobuf.Duration.getMinutes(): int",e=>e.getMinutes());c("google.protobuf.Duration.getSeconds(): int",e=>e.getSeconds());c("google.protobuf.Duration.getMilliseconds(): int",e=>e.getMilliseconds());function at(e,t){return e.type==="list"?e.valueType:e.type==="map"?e.keyType:t.getType("dyn")}function ct(e,t){let n=e[0];if(n instanceof g&&n[0]==="id")return n[1];throw new m(`${t} requires first argument to be an identifier`,n)}function ut(e,t,n,r){let s=e.variables.get(t);e.variables.set(t,n);try{return r()}finally{s!==void 0?e.variables.set(t,s):e.variables.delete(t)}}function j(e){return(t,n,r)=>{let s=ct(r,`${e}(var, predicate)`),i=at(n,t);return ut(t,s,i,()=>{let o=t.check(r[1]);if(o.isDynOrBool())return o;throw new m(`predicate must return bool, got '${o}'`,r[1])})}}function K(e,t,n){let r=`map(var, ${n.length===3?"filter, ":""}transform)`,s=ct(n,r),i=at(t,e);return ut(e,s,i,()=>{if(n.length===3){let u=e.check(n[1]);if(!u.isDynOrBool())throw new m(`${r} filter predicate must return bool, got '${u}'`,n[1])}let o=e.check(n[n.length-1]);return e.getType(`list<${o}>`)})}function xt(e,t,n){let r="filter(var, filter)",s=ct(n,r),i=at(t,e);return ut(e,s,i,()=>{let o=e.check(n[1]);if(o.isDynOrBool())return e.getType(`list<${i}>`);throw new m(`${r} predicate must return bool, got '${o}'`,n[1])})}c("list.all(ast, ast): bool",{handler:Ot,typeCheck:j("all")});c("map.all(ast, ast): bool",{handler:Ot,typeCheck:j("all")});c("list.exists(ast, ast): bool",{handler:kt,typeCheck:j("exists")});c("map.exists(ast, ast): bool",{handler:kt,typeCheck:j("exists")});c("list.exists_one(ast, ast): bool",{handler:It,typeCheck:j("exists_one")});c("map.exists_one(ast, ast): bool",{handler:It,typeCheck:j("exists_one")});c("list.map(ast, ast): list",{handler:Nt,typeCheck:K});c("list.map(ast, ast, ast): list",{handler:Ct,typeCheck:K});c("map.map(ast, ast): list",{handler:Nt,typeCheck:K});c("map.map(ast, ast, ast): list",{handler:Ct,typeCheck:K});c("list.filter(ast, ast): list",{handler:At,typeCheck:xt});c("map.filter(ast, ast): list",{handler:At,typeCheck:xt});var _=Symbol("predicateEvaluator");function Ot(e,t){let n=t[_]??=this.predicateEvaluator("all(var, predicate)",t),r=n.prepare(this,e),s=null;for(let i=0;i<r.length;i++)try{if(n.childEvaluateBool(r[i]))continue;return!1}catch(o){if(o.message.includes("Unknown variable")||o.message.includes("predicate result is not a boolean"))throw o;s??=o}if(s)throw s;return!0}function kt(e,t){let n=t[_]??=this.predicateEvaluator("exists(var, predicate)",t),r=n.prepare(this,e),s;for(let i=0;i<r.length;i++)try{if(n.childEvaluateBool(r[i]))return!0}catch(o){if(o.message.includes("Unknown variable")||o.message.includes("predicate result is not a boolean"))throw o;s??=o}if(s)throw s;return!1}function It(e,t){let n=t[_]??=this.predicateEvaluator("exists_one(var, predicate)",t),r=n.prepare(this,e),s=0;for(let i=0;i<r.length;i++)if(n.childEvaluateBool(r[i])!==!1&&++s>1)return!1;return s===1}function Nt(e,t){let n=t[_]??=this.predicateEvaluator("map(var, transform)",t),r=n.prepare(this,e),s=[];for(let i=0;i<r.length;i++)s[i]=n.childEvaluate(r[i]);return s}function Ct(e,t){let n=t[_]??=this.predicateEvaluator("map(var, filter, transform)",t),r=t[3][2],s=n.prepare(this,e),i=[];for(let o=0;o<s.length;o++)switch(n.childEvaluateBool(s[o])){case!1:continue;case!0:i.push(n.eval(r));continue}return i}function At(e,t){let n=t[_]??=this.predicateEvaluator("filter(var, predicate)",t),r=n.prepare(this,e),s=[];for(let i=0;i<r.length;i++){let o=r[i];n.childEvaluateBool(o)!==!1&&s.push(o)}return s}function Q(e,t,n){if(typeof e!="object"||e===null)return;let r=n.get(e.constructor);if(r)switch(r.name){case"map":return e instanceof Map?e.get(t):Object.hasOwn(e,t)?e[t]:void 0;case"list":return typeof t=="number"||typeof t=="bigint"?e[t]:void 0;case"bytes":return;default:let s=r.fields;return s?t in s?e[t]:void 0:Object.hasOwn(e,t)?e[t]:void 0}}function Bt(e){let t=0;for(let n of e)t++;return t}var lt=(...e)=>S.unaryOverload(...e),p=(...e)=>S.binaryOverload(...e);function ht(e,t){if(e<=9223372036854775807n&&e>=-9223372036854775808n)return e;throw new l(`integer overflow: ${e}`,t)}lt("!","bool",e=>!e);lt("-","int",e=>-e);p("int","*","int",(e,t,n)=>ht(e*t,n));p("int","+","int",(e,t,n)=>ht(e+t,n));p("int","-","int",(e,t,n)=>ht(e-t,n));p("int","/","int",(e,t,n)=>{if(t===0n)throw new l("division by zero",n);return e/t});p("int","%","int",(e,t,n)=>{if(t===0n)throw new l("modulo by zero",n);return e%t});lt("-","double",e=>-e);p("double","*","double",(e,t)=>e*t);p("double","+","double",(e,t)=>e+t);p("double","-","double",(e,t)=>e-t);p("double","/","double",(e,t,n)=>{if(t===0)throw new l("division by zero",n);return e/t});p("string","+","string",(e,t)=>e+t);p("list","+","list",(e,t)=>[...e,...t]);p("bytes","+","bytes",(e,t)=>{let n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n});var N="google.protobuf.Duration";p(N,"+",N,(e,t)=>e.addDuration(t));p(N,"-",N,(e,t)=>e.subtractDuration(t));p(N,"==",N,(e,t)=>e.seconds===t.seconds&&e.nanos===t.nanos);var V="google.protobuf.Timestamp";p(V,"==",V,(e,t)=>e.getTime()===t.getTime());p(V,"-",N,(e,t)=>t.subtractTimestamp(e));p(V,"+",N,(e,t)=>t.extendTimestamp(e));p(N,"+",V,(e,t)=>e.extendTimestamp(t));function Qt(e,t,n,r){if(t instanceof Set&&t.has(e))return!0;for(let s of t)if(z(e,s,r))return!0;return!1}function Wt(e,t){return Array.isArray(t)?t.includes(e):t.has(e)}for(let e of["string","bool","null"])p(e,"in","list",Wt);for(let e of["int","double","list","map"])p(e,"in","list",Qt);for(let e of["string","int","double","bool","null"])p(e,"in","map",(t,n)=>n instanceof Map?n.get(t)!==void 0:Object.hasOwn(n,t)?n[t]!==void 0:!1);for(let e of["string","int","double","bool","null","bytes","map","list","google.protobuf.Duration","google.protobuf.Timestamp"])p(e,"==","dyn",()=>!1);for(let e of["type","null","bool","string","int","double"])p(e,"==",e,(t,n)=>t===n);p("int","==","dyn<double>",(e,t)=>e==t);p("int","==","dyn<uint>",(e,t)=>e==t.valueOf());p("uint","==","dyn<double>",(e,t)=>e.valueOf()==t);p("uint","==","dyn<int>",(e,t)=>e.valueOf()==t);p("double","==","dyn<int>",(e,t)=>e==t);p("double","==","dyn<uint>",(e,t)=>e==t.valueOf());p("bytes","==","bytes",(e,t)=>{let n=e.length;if(n!==t.length)return!1;for(;n--;)if(e[n]!==t[n])return!1;return!0});p("list","==","list",(e,t,n,r)=>{if(Array.isArray(e)&&Array.isArray(t)){let o=e.length;if(o!==t.length)return!1;for(let u=0;u<o;u++)if(!z(e[u],t[u],r))return!1;return!0}if(e instanceof Set&&t instanceof Set){if(e.size!==t.size)return!1;for(let o of e)if(!t.has(o))return!1;return!0}let s=e instanceof Set?t:e,i=e instanceof Set?e:t;if(!Array.isArray(s)||s.length!==i?.size)return!1;for(let o=0;o<s.length;o++)if(!i.has(s[o]))return!1;return!0});p("map","==","map",(e,t,n,r)=>{if(e instanceof Map&&t instanceof Map){if(e.size!==t.size)return!1;for(let[o,u]of e)if(!(t.has(o)&&z(u,t.get(o),r)))return!1;return!0}if(e instanceof Map||t instanceof Map){let o=e instanceof Map?t:e,u=e instanceof Map?e:t,h=Object.keys(o);if(u.size!==h.length)return!1;for(let[f,w]of u)if(!(f in o&&z(w,o[f],r)))return!1;return!0}let s=Object.keys(e),i=Object.keys(t);if(s.length!==i.length)return!1;for(let o=0;o<s.length;o++){let u=s[o];if(!(u in t&&z(e[u],t[u],r)))return!1}return!0});p("uint","+","uint",(e,t)=>new x(e.valueOf()+t.valueOf()));p("uint","-","uint",(e,t)=>new x(e.valueOf()-t.valueOf()));p("uint","*","uint",(e,t)=>new x(e.valueOf()*t.valueOf()));p("uint","/","uint",(e,t,n)=>{if(t.valueOf()===0n)throw new l("division by zero",n);return new x(e.valueOf()/t.valueOf())});p("uint","%","uint",(e,t,n)=>{if(t.valueOf()===0n)throw new l("modulo by zero",n);return new x(e.valueOf()%t.valueOf())});for(let[e,t]of[["int","int"],["uint","uint"],["double","double"],["string","string"],["google.protobuf.Timestamp","google.protobuf.Timestamp"],["google.protobuf.Duration","google.protobuf.Duration"],["int","uint"],["int","double"],["double","int"],["double","uint"],["uint","int"],["uint","double"]])p(e,"<",t,(n,r)=>n<r),p(e,"<=",t,(n,r)=>n<=r),p(e,">",t,(n,r)=>n>r),p(e,">=",t,(n,r)=>n>=r);function z(e,t,n){if(e===t)return!0;switch(typeof e){case"string":return!1;case"bigint":return typeof t=="number"?e==t:!1;case"number":return typeof t=="bigint"?e==t:!1;case"boolean":return!1;case"object":if(typeof t!="object"||e===null||t===null)return!1;let r=n.objectTypesByConstructor.get(e.constructor),s=n.objectTypesByConstructor.get(t.constructor);if(!r||r!==s)return!1;let i=n.overloads["=="][r.name]?.[s.name]?.handler;return i?i(e,t,null,n):!1}throw new l(`Cannot compare values of type ${typeof e}`)}var W=class{constructor({environment:t,variables:n,objectTypes:r,objectTypesByConstructor:s,overloads:i,registry:o}){this.environment=t,this.variables=n,this.objectTypes=r,this.objectTypesByConstructor=s,this.overloads=i,this.registry=o}typesEqual(t,n){return t.type===n.type}getType(t){return this.registry.getType(t)}check(t){switch(t[0]){case"value":return this.inferLiteralType(t[1]);case"id":return this.checkVariable(t);case".":case"[]":return this.checkAccess(t);case"call":return this.checkCall(t);case"rcall":return this.checkReceiverCall(t);case"list":return this.checkList(t);case"map":return this.checkMap(t);case"?:":return this.checkTernary(t);case"||":case"&&":return this.checkLogicalOp(t);case"!_":case"-_":return this.checkUnaryOperator(t);case"==":case"!=":case"<":case"<=":case">":case">=":case"+":case"-":case"*":case"/":case"%":case"in":return this.checkBinaryOperator(t);default:throw new m(`Unknown operation: ${t[0]}`,t)}}inferLiteralType(t){switch(typeof t){case"string":return this.getType("string");case"bigint":return this.getType("int");case"number":return this.getType("double");case"boolean":return this.getType("bool");case"object":if(t===null)return this.getType("null");let n=this.objectTypesByConstructor.get(t.constructor);if(n)return this.getType(n.name);throw new m(`Unexpected object in AST: ${t.constructor?.name||t}`);default:return this.getType("dyn")}}checkVariable(t){let n=t[1],r=this.variables.get(n);if(r!==void 0)return r;throw new m(`Unknown variable: ${n}`,t)}checkAccess(t){let n=this.check(t[1]),r=n.type;if(r==="dyn")return this.getType("dyn");let i=(t[0]==="[]"?this.check(t[2]):this.getType("string")).type;if(r==="list"){if(i!=="int"&&i!=="dyn")throw new m(`List index must be int, got '${i}'`,t);return n.valueType}if(r==="map")return n.valueType;let o=this.objectTypes.get(r);if(o){if(!(i==="string"||i==="dyn"))throw new m(`Cannot index type '${r}' with type '${i}'`,t);if(o.fields){let u=t[0]==="."?t[2]:void 0;if(u){let h=o.fields[u];if(h)return h;throw new m(`No such key: ${u}`,t)}}return this.getType("dyn")}throw new m(`Cannot index type '${r}'`,t)}checkCall(t){let n=t[1],r=t[2].length,s=(t.functionCandidates??=this.registry.getFunctionCandidates(null,n,r)).filterByReceiverType(null);if(!s.exists)throw new m(`Function not found: '${n}'`,t);if(s.hasMacro){let h=s.functions[0];return h.typeCheck?h.typeCheck(this,null,t[2]):h.returnType}let o=t[2].map(h=>this.check(h)).map(h=>h.type),u=s.findMatch(o);if(!u)throw new m(`found no matching overload for '${n}(${o.join(", ")})'`,t);return u.returnType}checkReceiverCall(t){let n=t[1],r=this.check(t[2]),s=r.type,i=t[3].length,o=t.functionCandidates??=this.registry.getFunctionCandidates(s,n,i);if(!o.exists)throw new m(`Function not found: '${n}' for value of type '${s}'`,t);if(r.type==="dyn")return r;let u=o.filterByReceiverType(s);if(u.hasMacro){let y=u.functions[0];return y.typeCheck?y.typeCheck(this,r,t[3]):y.returnType}let f=t[3].map(y=>this.check(y)).map(y=>y.type),w=u.findMatch(f);if(!w)throw new m(`found no matching overload for '${s}.${n}(${f.join(", ")})'`,t);return w.returnType}checkList(t){let n=t[1];if(n.length===0)return this.getType("list");let r=this.check(n[0]);return n.every(i=>this.typesEqual(r,this.check(i)))?this.getType(`list<${r}>`):this.getType("list")}checkMap(t){let n=t[1];if(n.length===0)return this.getType("map");let r=this.check(n[0][0]),s=this.check(n[0][1]),i=!0,o=!0;for(let f=1;f<n.length;f++){let[w,y]=n[f],A=this.check(w),B=this.check(y);this.typesEqual(A,r)||(i=!1),this.typesEqual(B,s)||(o=!1)}let u=i?r:"dyn",h=o?s:"dyn";return this.getType(`map<${u}, ${h}>`)}checkTernary(t){let n=this.check(t[1]);if(n.type!=="bool"&&n.type!=="dyn")throw new m(`Ternary condition must be bool, got '${n}'`,t);let r=this.check(t[2]),s=this.check(t[3]);return this.typesEqual(r,s)?r:this.getType("dyn")}checkLogicalOp(t){let n=this.check(t[1]),r=this.check(t[2]);if(n.type!=="bool"&&n.type!=="dyn")throw new m(`Logical operator requires bool operands, got '${n}'`,t);if(r.type!=="bool"&&r.type!=="dyn")throw new m(`Logical operator requires bool operands, got '${r}'`,t);return this.getType("bool")}checkUnaryOperator(t){let n=t[0],s=this.check(t[1]).type;if(s==="dyn")return n==="!_"?this.getType("bool"):this.getType("dyn");let i=this.overloads[n]?.[s];if(i)return i.returnType;throw new m(`no such overload: ${n[0]}${s}`,t)}checkBinaryOperator(t){let n=this.check(t[1]).type,r=this.check(t[2]).type,s=t[0];if(n==="dyn"||r==="dyn")return s==="<"||s==="<="||s===">"||s===">="||s==="=="||s==="!="||s==="in"?this.getType("bool"):this.getType("dyn");let i=this.overloads[s]?.[n]?.[r];if(i)return i.returnType;throw new m(`no such overload: ${n} ${t[0]} ${r}`,t)}};var Jt=new Map(Object.entries({value(e){return e[1]},id(e,t){let n=e[1],r=t.variables.get(n);if(r===void 0)throw new l(`Unknown variable: ${n}`,e);let s=t.ctx.get(n);if(s===void 0)throw new l(`Unknown variable: ${n}`,e);let i=t.debugType(s);if(r.type===i||r.type==="dyn")return s;throw new l(`Variable '${n}' is not of type '${r.type}', got '${i}'`,e)},"||"(e,t){try{let r=t.eval(e[1]);if(r===!0)return!0;if(r!==!1)throw new l("Left operand of || is not a boolean",e[1])}catch(r){if(r.message.includes("Unknown variable")||r.message.includes("is not a boolean"))throw r;let s=t.eval(e[2]);if(s===!0)return!0;throw s===!1?r:new l("Right operand of || is not a boolean",e[2])}let n=t.eval(e[2]);if(typeof n=="boolean")return n;throw new l("Right operand of || is not a boolean",e[2])},"&&"(e,t){try{let r=t.eval(e[1]);if(r===!1)return!1;if(r!==!0)throw new l("Left operand of && is not a boolean",e[1])}catch(r){if(r.message.includes("Unknown variable")||r.message.includes("is not a boolean"))throw r;let s=t.eval(e[2]);if(s===!1)return!1;throw s===!0?r:new l("Right operand of && is not a boolean",e[2])}let n=t.eval(e[2]);if(typeof n=="boolean")return n;throw new l("Right operand of && is not a boolean",e[2])},"."(e,t){let n=t.eval(e[1]),r=e[2],s=Q(n,r,t.objectTypesByConstructor);if(s!==void 0)return s;throw new l(`No such key: ${r}`,e)},"[]"(e,t){let n=t.eval(e[1]),r=t.eval(e[2]),s=Q(n,r,t.objectTypesByConstructor);if(s!==void 0)return s;if(Array.isArray(n)){if(!(typeof r=="number"||typeof r=="bigint"))throw new l(`No such key: ${r} (${t.debugType(r)})`,e);if(r<0)throw new l(`No such key: index out of bounds, index ${r} < 0`,e);if(r>=n.length)throw new l(`No such key: index out of bounds, index ${r} >= size ${n.length}`,e)}throw new l(`No such key: ${r}`,e)},rcall(e,t){let n=e[1],r=t.eval(e[2]),s=t.debugType(r),i=e[3].length,o=e.functionCandidates??=t.registry.getFunctionCandidates(s,n,i);if(!o.exists)throw new l(`Function not found: '${n}' for value of type '${s}'`,e);let u=o.filterByReceiverType(s),h,f;u.hasMacro?f=e[3].map(()=>"ast"):(h=e[3].map(y=>t.eval(y)),f=h.map(y=>t.debugType(y)));let w=u.findMatch(f);if(!w)throw new l(`found no matching overload for '${s}.${n}(${f.join(", ")})'`,e);try{return w.macro?w.handler.call(t,r,e):w.handler.call(t,r,...h)}catch(y){throw y instanceof l?y.withAst(e):y}},call(e,t){let n=e[1],r=e[2].length,s=e.functionCandidates??=t.registry.getFunctionCandidates(null,n,r);if(s.exists===!1)throw new l(`Function not found: '${n}'`,e);let i=s.filterByReceiverType(null),o,u;s.hasMacro?u=e[2].map(()=>"ast"):(o=e[2].map(f=>t.eval(f)),u=o.map(f=>t.debugType(f)));let h=i.findMatch(u);if(!h)throw new l(`found no matching overload for '${n}(${u.join(", ")})'`,e);try{return h.macro?h.handler.call(t,e):h.handler.apply(t,o)}catch(f){throw f instanceof l?f.withAst(e):f}},list(e,t){let n=e[1],r=new Array(n.length);for(let s=0;s<n.length;s++)r[s]=t.eval(n[s]);return r},map(e,t){let n={},r=e[1];for(let s=0;s<r.length;s++){let i=r[s];n[t.eval(i[0])]=t.eval(i[1])}return n},"?:"(e,t){let n=t.eval(e[1]);if(typeof n!="boolean")throw new l("Ternary condition must be a boolean");return n?t.eval(e[2]):t.eval(e[3])},"!_":St,"-_":St,"!=":O,"==":O,in:O,"+":O,"-":O,"*":O,"/":O,"%":O,"<":O,"<=":O,">":O,">=":O}));function St(e,t){let n=t.eval(e[1]),r=t.debugType(n),s=t.overloads[e[0]]?.[r];if(s)return s.handler(n);throw new l(`no such overload: ${e[0][0]}${r}`,e)}var Xt=Symbol("astCache");function Zt(e,t,n,r){let s=(t[Xt]??={})[n]??={},i=s[r];if(i!==void 0)return i;let o=te(e,t,n,r);return s[r]=o,o}function te(e,t,n,r){let s=e.overloads[t[0]],i=e.isDynamic(t[1]),o=e.isDynamic(t[2]);return!i&&!o?!1:i&&o&&s[`dyn<${n}>`]?.[`dyn<${r}>`]||i&&s[`dyn<${n}>`]?.[r]||o&&s[n]?.[`dyn<${r}>`]||i&&s.dyn?.[r]||o&&s[n]?.dyn||i&&o&&s.dyn?.dyn||!1}function O(e,t){let n=t.eval(e[1]),r=t.eval(e[2]),s=t.debugType(n),i=t.debugType(r),o=t.overloads[e[0]][s]?.[i]||Zt(t,e,s,i);if(o)return o.handler(n,r,e,t);throw new l(`no such overload: ${s} ${e[0]} ${i}`,e)}var Rt=[[void 0,"map"],[Object,"map"],[Map,"map"],[Array,"list"],[Uint8Array,"bytes"],[Date,"google.protobuf.Timestamp"],[U,"google.protobuf.Duration"],[x,"uint"],[T,"type"]];typeof Buffer<"u"&&Rt.push([Buffer,"bytes"]);var ee={type:"dyn"},pt=class extends Map{get(t){return super.get(t)||ee}},J=class{},ft=class extends J{#t;#e;constructor(t){super(),this.#e=t}setPrimaryContext(t){if(this.#t=t,!t)return this.get=this.#r;if(typeof t!="object")throw new l("Context must be an object");t instanceof Map?this.get=this.#n:this.get=this.#i}get(){throw new l("Context not initialized")}#r(t){return this.#e.get(t)}#i(t){let n=Object.hasOwn(this.#t,t)?this.#t[t]:void 0;return n!==void 0?n:this.#e?.get(t)}#n(t){let n=this.#t.get(t);return n!==void 0?n:this.#e?.get(t)}},gt=class extends J{#t;#e;#r;constructor(t){super(),this.#e=t}setContext(t){this.#t=t}setOverride(t){this.#r=t}get(t){return t===this.#e?this.#r:this.#t.get(t)}},dt=class{#t;#e;#r;constructor(t,n,r){this.#t=t,this.#e=n,this.#r=r}get(t){return t===this.#e?this.#r:this.#t.get(t)}},Y=class{#t;#e;#r;#i;#n;#s;#o;#a;constructor(t){t?.unlistedVariablesAreDyn?this.#t=new pt:this.#t=new Map,this.#s=S.clone(),this.#i=this.#s.overloads,this.#e=this.#s.objectTypes,this.#r=this.#s.objectTypesByConstructor,this.#n=this.#s.functions;for(let[r,s]of Rt)this.#s.registerType(s,r,!0);let n={environment:this,variables:this.#t,overloads:this.#i,functions:this.#n,objectTypes:this.#e,objectTypesByConstructor:this.#r,registry:this.#s};this.#o=new X(n),this.#a=new W(n),Object.freeze(this)}registerFunction(t,n){return this.#s.registerFunctionOverload(t,n),this}registerOperator(t,n){return this.#s.registerOperatorOverload(t,n),this}registerType(t,n){return this.#s.registerType(t,n),this}registerVariable(t,n){if(this.#t.has(t))throw new Error(`Variable already registered: ${t}`);return this.#t.set(t,this.#s.getType(n)),this}hasVariable(t){return this.#t.has(t)}check(t){try{let n=this.#a.check(new D(t).parse());return{valid:!0,type:this.#c(n)}}catch(n){return{valid:!1,error:n}}}#l(t){try{let n=this.#a.check(t);return{valid:!0,type:this.#c(n)}}catch(n){return{valid:!1,error:n}}}#c(t){return t.type==="list"&&`${t}`=="list<dyn>"?"list":t.type==="map"&&`${t}`=="map<dyn, dyn>"?"map":`${t}`}parse(t){let n=new D(t).parse(),r=this.#u.bind(this,n);return r.check=this.#l.bind(this,n),r.ast=n,r}evaluate(t,n){return this.#u(new D(t).parse(),n)}#u(t,n){let r=this.#o;return r.ctx.setPrimaryContext(n),r.eval(t)}};function Mt(e){throw new l(`Unsupported type: ${e}`)}var X=class{handlers=Jt;constructor({environment:t,registry:n,variables:r,overloads:s,functions:i,objectTypes:o,objectTypesByConstructor:u,ctx:h}){this.environment=t,this.variables=r,this.overloads=s,this.objectTypes=o,this.objectTypesByConstructor=u,this.functions=i,this.registry=n,!h&&(this.ctx=new ft(new Map(Object.entries(k))))}predicateEvaluator(t,n){return new yt(this,t,n)}debugType(t){switch(typeof t){case"string":return"string";case"bigint":return"int";case"number":return"double";case"boolean":return"bool";case"object":return t===null?"null":this.objectTypesByConstructor.get(t.constructor)?.name||Mt(t.constructor?.name||typeof t);default:Mt(typeof t)}}eval(t){let n=this.handlers.get(t[0]);if(n)return n(t,this);throw new l(`Unknown operation: ${t[0]}`,t)}isDynamic(t){if(!(t instanceof g))return!1;switch(t[0]){case"value":return!1;case"id":return!0;case".":case"[]":return this.isDynamic(t[1]);case"+":case"-":case"-_":return!1;case"?:":return this.isDynamic(t[2])||this.isDynamic(t[3]);case"rcall":case"call":{let n=t[1],r=t[0]==="rcall";switch((t.functionCandidates??=this.registry.getFunctionCandidates(r,n,t[r?3:2].length)).returnType?.type){case void 0:case"dyn":return!0;case"list":case"map":return this.isDynamic(t[2]);default:return!1}}case"list":{let n=t[1];for(let r=0;r<n.length;r++)if(this.isDynamic(n[r]))return!0;return!1}case"map":{let n=t[1];for(let r=0;r<n.length;r++){let s=n[r];if(this.isDynamic(s[0])||this.isDynamic(s[1]))return!0}return!1}default:return!1}}},yt=class extends X{constructor(t,n,r){super(t);let[s,i]=r[3];if(s?.[0]!=="id")throw new l(`${n} invalid predicate iteration variable`,r);this.ast=r,this.functionName=n,this.predicateVariable=s[1],this.predicateExpression=i,this.variables=new dt(this.variables,this.predicateVariable,this.registry.getType("dyn")),this.ctx=new gt(this.predicateVariable)}prepare(t,n){return this.ctx.setContext(t.ctx),this.getIterableItems(n)}getIterableItems(t){if(Array.isArray(t))return t;if(t instanceof Set)return[...t];if(t instanceof Map)return[...t.keys()];if(typeof t=="object")return Object.keys(t);throw new l(`${this.functionName} cannot iterate over non-collection type. argument must be a list, map, or object`,this.ast)}childEvaluateBool(t){switch(this.ctx.setOverride(t),this.eval(this.predicateExpression)){case!0:return!0;case!1:return!1;default:throw new l(`${this.functionName} predicate result is not a boolean`,Array.isArray(this.predicateExpression)?this.predicateExpression:this.ast)}}childEvaluate(t){return this.ctx.setOverride(t),this.eval(this.predicateExpression)}},Dt=new Y({unlistedVariablesAreDyn:!0});function Ut(e){return Dt.parse(e)}function Lt(e,t,n){return Dt.evaluate(e,t,n)}function jt(e){if(e===null)return"null";if(typeof e=="boolean"||typeof e=="bigint")return String(e);if(typeof e=="string")return ne(e);if(e instanceof Uint8Array)return _t(e);if(typeof e=="number")return e%1===0?`${e}.0`:e.toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:9});if(typeof e=="object"){let t=Object.keys(e);if(t.every(n=>/^\d+$/.test(n))){let n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=e[r];return _t(n)}}return String(e)}function v(e){if(Array.isArray(e)&&e[0]==="value")return jt(e[1]);let[t,...n]=e;switch(t){case"value":return jt(n[0]);case"id":return n[0];case"||":case"&&":case"==":case"!=":case"<":case"<=":case">":case">=":case"in":case"+":case"-":case"*":case"/":case"%":return`${C(n[0],t)} ${t} ${C(n[1],t)}`;case"!_":return`!${C(n[0],t)}`;case"-_":return n[0]instanceof g&&["+","-","*","/","%"].includes(n[0][0])?`-(${v(n[0])})`:`-${v(n[0])}`;case".":return`${C(n[0],t)}.${n[1]}`;case"[]":return`${C(n[0],t)}[${v(n[1])}]`;case"call":return`${n[0]}(${n[1].map(v).join(", ")})`;case"rcall":return`${C(n[1],t)}.${n[0]}(${n[2].map(v).join(", ")})`;case"list":return`[${n[0].map(v).join(", ")}]`;case"map":return`{${n[0].map(([r,s])=>`${v(r)}: ${v(s)}`).join(", ")}}`;case"?:":return`${C(n[0],t)} ? ${C(n[1],t)} : ${v(n[2])}`;default:throw new Error(`Unknown AST operation: ${t}`)}}function ne(e){let t=e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t").replace(/\f/g,"\\f").replace(/[\b]/g,"\\b").replace(/\v/g,"\\v"),n="";for(let r=0;r<t.length;r++){let s=t.charCodeAt(r);s<32||s>126?n+=s<=65535?`\\u${s.toString(16).padStart(4,"0")}`:`\\U${s.toString(16).padStart(8,"0")}`:n+=t[r]}return`"${n}"`}function _t(e){let t='b"';for(let n of e)n===92?t+="\\\\":n===34?t+='\\"':n===10?t+="\\n":n===13?t+="\\r":n===9?t+="\\t":n>=32&&n<=126?t+=String.fromCharCode(n):t+=`\\x${n.toString(16).padStart(2,"0")}`;return`${t}"`}var Pt={"?:":1,"||":2,"&&":3,"==":4,"!=":4,"<":5,"<=":5,">":5,">=":5,in:5,"+":6,"-":6,"-_":6,"*":7,"/":7,"%":7,"!_":8,".":9,"[]":9,call:9,rcall:9};function re(e,t){if(!(e instanceof g))return!1;let n=e[0],r=Pt[t]||0,s=Pt[n]||0;return n==="value"||n==="id"||n==="call"||n==="rcall"||n==="list"||n==="map"||(t==="*"||t==="/"||t==="%")&&n==="-_"||t==="*"&&n==="*"&&e[1]instanceof g&&e[1][0]==="-_"||(n==="."||n==="[]")&&(t==="."||t==="[]"||t==="rcall")?!1:t==="?:"?n==="?:":t==="!_"||t==="-_"?s<r:!!(t==="/"&&(n==="*"||n==="+"||n==="-")||n==="/"&&t!==void 0||(t==="*"||t==="/")&&["+","-","*","/"].includes(n)&&e.length>2&&e[1]instanceof g&&e[2]instanceof g||s<r||s===r&&(t==="/"||t==="%")&&(n==="/"||n==="%"))}function C(e,t){return re(e,t)?`(${v(e)})`:v(e)}var Ce={parse:Ut,evaluate:Lt,Environment:Y,ParseError:d,EvaluationError:l,TypeError:m,serialize:v};export{Y as Environment,l as EvaluationError,d as ParseError,m as TypeError,Ce as default,Lt as evaluate,Ut as parse,v as serialize};
